// ==========================================
// BUILD.GRADLE (Project Level)
// ==========================================
// Configura√ß√£o principal do projeto Android
// Otimizado para Expo SDK 52 + React Native 0.76.7 + Firebase

buildscript {
  ext {
    // Vers√µes das ferramentas de build
    buildToolsVersion = "34.0.0"
    minSdkVersion = 23
    compileSdkVersion = 34
    targetSdkVersion = 34
    ndkVersion = "26.1.10909125"
    
    // Vers√µes espec√≠ficas para compatibilidade
    kotlinVersion = "1.9.24"
    gradleVersion = "8.10.2"
    
    // Configura√ß√µes do React Native
    newArchEnabled = providers.gradleProperty("newArchEnabled").getOrElse("true").toBoolean()
    hermesEnabled = providers.gradleProperty("hermesEnabled").getOrElse("true").toBoolean()
  }

  // Reposit√≥rios para depend√™ncias de build
  repositories {
    google()
    mavenCentral()
    maven { url 'https://www.jitpack.io' }
  }

  // Depend√™ncias do classpath de build
  dependencies {
    // Plugin Android Gradle
    classpath('com.android.tools.build:gradle:8.7.3')
    
    // Plugin Kotlin
    classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
    
    // Plugin React Native
    classpath('com.facebook.react:react-native-gradle-plugin')
    
    // Plugin Google Services (Firebase)
    classpath('com.google.gms:google-services:4.4.2')
    
    // Plugin Firebase Crashlytics (opcional)
    classpath('com.google.firebase:firebase-crashlytics-gradle:3.0.2')
    
    // Plugin Firebase Performance (opcional)
    classpath('com.google.firebase:perf-plugin:1.4.2')
  }
}

// ==========================================
// CONFIGURA√á√ÉO DO REACT NATIVE
// ==========================================
def reactNativeAndroidDir = new File(
  providers.exec {
    workingDir(rootDir)
    commandLine("node", "--print", "require.resolve('react-native/package.json')")
  }.standardOutput.asText.get().trim(),
  "../android"
)

// ==========================================
// REPOSIT√ìRIOS GLOBAIS
// ==========================================
allprojects {
  repositories {
    // Reposit√≥rio do React Native (deve vir primeiro)
    maven {
      url(reactNativeAndroidDir)
      name("React Native Android")
    }

    // Reposit√≥rios principais
    google()
    mavenCentral()
    
    // Reposit√≥rios adicionais
    maven { url 'https://www.jitpack.io' }
    maven { url 'https://maven.google.com' }
    
    // Reposit√≥rio local do npm (para depend√™ncias espec√≠ficas)
    maven {
      url("${rootProject.projectDir}/../node_modules/@react-native-community/cli-platform-android/native_modules.gradle")
    }
  }

  // ==========================================
  // CONFIGURA√á√ïES GLOBAIS DE BUILD
  // ==========================================
  configurations.all {
    resolutionStrategy {
      // For√ßa vers√µes espec√≠ficas para evitar conflitos
      force 'androidx.core:core:1.12.0'
      force 'androidx.core:core-ktx:1.12.0'
      force 'androidx.appcompat:appcompat:1.6.1'
      force 'androidx.fragment:fragment:1.6.2'
      force 'androidx.activity:activity:1.8.2'
      
      // Configura√ß√µes espec√≠ficas para Firebase
      force 'com.google.android.gms:play-services-base:18.5.0'
      force 'com.google.android.gms:play-services-basement:18.4.0'
      force 'com.google.android.gms:play-services-tasks:18.2.0'
      
      // Evita conflitos de vers√£o do Kotlin
      force "org.jetbrains.kotlin:kotlin-stdlib:$kotlinVersion"
      force "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlinVersion"
    }
    
    // Exclui depend√™ncias problem√°ticas
    exclude group: 'com.facebook.fbjni', module: 'fbjni-java-only'
    exclude group: 'com.facebook.flipper'
  }
}

// ==========================================
// PLUGINS PRINCIPAIS
// ==========================================
apply plugin: "expo-root-project"
apply plugin: "com.facebook.react.rootproject"

// ==========================================
// CONFIGURA√á√ïES DE PERFORMANCE
// ==========================================
// Configura√ß√µes para melhorar performance do build
gradle.projectsEvaluated {
  tasks.withType(JavaCompile) {
    options.compilerArgs << "-Xlint:unchecked" << "-Xlint:deprecation"
  }
}

// ==========================================
// CONFIGURA√á√ïES ESPEC√çFICAS PARA FIREBASE
// ==========================================
// Estas configura√ß√µes garantem que o Firebase funcione
// corretamente com React Native e Expo

subprojects { subproject ->
  afterEvaluate {
    if (subproject.plugins.hasPlugin('com.android.application') ||
        subproject.plugins.hasPlugin('com.android.library')) {
      
      // Configura√ß√µes Android espec√≠ficas para Firebase
      subproject.android {
        compileSdkVersion rootProject.ext.compileSdkVersion
        
        defaultConfig {
          minSdkVersion rootProject.ext.minSdkVersion
          targetSdkVersion rootProject.ext.targetSdkVersion
        }
        
        // Configura√ß√µes de compila√ß√£o para Firebase
        compileOptions {
          sourceCompatibility JavaVersion.VERSION_11
          targetCompatibility JavaVersion.VERSION_11
        }
        
        // Configura√ß√µes Kotlin para Firebase
        if (subproject.plugins.hasPlugin('org.jetbrains.kotlin.android')) {
          kotlinOptions {
            jvmTarget = '11'
          }
        }
      }
    }
  }
}

// ==========================================
// CONFIGURA√á√ïES DE LIMPEZA
// ==========================================
task clean(type: Delete) {
  delete rootProject.buildDir
  delete file("${rootProject.projectDir}/.gradle")
  delete file("${rootProject.projectDir}/build")
}

// ==========================================
// CONFIGURA√á√ïES DE MEM√ìRIA E PERFORMANCE
// ==========================================
// Estas configura√ß√µes s√£o aplicadas via gradle.properties
// mas podem ser sobrescritas aqui se necess√°rio

// Configura√ß√£o para builds paralelos
if (project.hasProperty('org.gradle.parallel')) {
  org.gradle.parallel = true
}

// Configura√ß√£o para daemon do Gradle
if (project.hasProperty('org.gradle.daemon')) {
  org.gradle.daemon = true
}

// ==========================================
// VERIFICA√á√ïES DE INTEGRIDADE
// ==========================================
// Verifica se as depend√™ncias cr√≠ticas est√£o presentes
gradle.taskGraph.whenReady { taskGraph ->
  if (taskGraph.hasTask(':app:assembleDebug') || taskGraph.hasTask(':app:assembleRelease')) {
    println "üî• Iniciando build com Firebase nativo integrado"
    println "üì± React Native: 0.76.7"
    println "üöÄ Expo SDK: 52"
    println "‚ö° Kotlin: $kotlinVersion"
    println "üîß Gradle: $gradleVersion"
  }
}